# Gizmos UI Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add UI panel for gizmo controls, allowing users to select gizmo mode, coordinate space, snap settings, and view/edit the selected structure's transform.

**Architecture:** Create UI data structures and panel builders in polyscope-ui that interact with the existing Gizmo backend in polyscope-core. The UI displays current selection info, gizmo mode/space toggles, snap settings, and transform editing controls.

**Tech Stack:** Rust, egui, glam

---

## Task 1: Add GizmoSettings Struct to UI Crate

**Files:**
- Modify: `crates/polyscope-ui/src/panels.rs` (add after GroupSettings)

**Step 1: Add GizmoSettings struct**

Add after the `GroupSettings` and related code in `crates/polyscope-ui/src/panels.rs`:

```rust
/// Gizmo settings for UI.
#[derive(Debug, Clone)]
pub struct GizmoSettings {
    /// Gizmo mode (0=Translate, 1=Rotate, 2=Scale).
    pub mode: u32,
    /// Coordinate space (0=World, 1=Local).
    pub space: u32,
    /// Whether gizmo is visible.
    pub visible: bool,
    /// Translation snap value (0 = disabled).
    pub snap_translate: f32,
    /// Rotation snap value in degrees (0 = disabled).
    pub snap_rotate: f32,
    /// Scale snap value (0 = disabled).
    pub snap_scale: f32,
}

impl Default for GizmoSettings {
    fn default() -> Self {
        Self {
            mode: 0,  // Translate
            space: 0, // World
            visible: true,
            snap_translate: 0.0,
            snap_rotate: 0.0,
            snap_scale: 0.0,
        }
    }
}

/// Current selection info for UI.
#[derive(Debug, Clone, Default)]
pub struct SelectionInfo {
    /// Whether something is selected.
    pub has_selection: bool,
    /// Selected structure type name.
    pub type_name: String,
    /// Selected structure name.
    pub name: String,
    /// Transform translation.
    pub translation: [f32; 3],
    /// Transform rotation as Euler angles in degrees.
    pub rotation_degrees: [f32; 3],
    /// Transform scale.
    pub scale: [f32; 3],
}
```

**Step 2: Run compilation check**

Run: `cargo check -p polyscope-ui`
Expected: No errors

**Step 3: Commit**

```bash
git add crates/polyscope-ui/src/panels.rs
git commit -m "feat(ui): add GizmoSettings and SelectionInfo structs"
```

---

## Task 2: Add GizmoAction Enum

**Files:**
- Modify: `crates/polyscope-ui/src/panels.rs`

**Step 1: Add GizmoAction enum**

Add after `SelectionInfo`:

```rust
/// Actions that can be triggered from the gizmo UI.
#[derive(Debug, Clone, PartialEq)]
pub enum GizmoAction {
    /// No action.
    None,
    /// Gizmo settings changed.
    SettingsChanged,
    /// Transform was edited.
    TransformChanged,
    /// Deselect was clicked.
    Deselect,
    /// Reset transform was clicked.
    ResetTransform,
}
```

**Step 2: Run compilation check**

Run: `cargo check -p polyscope-ui`
Expected: No errors

**Step 3: Commit**

```bash
git add crates/polyscope-ui/src/panels.rs
git commit -m "feat(ui): add GizmoAction enum"
```

---

## Task 3: Add Gizmo Section Builder

**Files:**
- Modify: `crates/polyscope-ui/src/panels.rs`

**Step 1: Add build_gizmo_section function**

Add after `GizmoAction`:

```rust
/// Builds the gizmo/transform section.
/// Returns an action if one was triggered.
pub fn build_gizmo_section(
    ui: &mut Ui,
    settings: &mut GizmoSettings,
    selection: &mut SelectionInfo,
) -> GizmoAction {
    let mut action = GizmoAction::None;

    CollapsingHeader::new("Transform / Gizmo")
        .default_open(false)
        .show(ui, |ui| {
            // Selection info
            if selection.has_selection {
                ui.horizontal(|ui| {
                    ui.label("Selected:");
                    ui.label(format!("[{}] {}", selection.type_name, selection.name));
                });

                if ui.button("Deselect").clicked() {
                    action = GizmoAction::Deselect;
                }

                ui.separator();
            } else {
                ui.label("No selection");
                ui.label("Click a structure to select");
                ui.separator();
            }

            // Gizmo visibility
            if ui.checkbox(&mut settings.visible, "Show gizmo").changed() {
                action = GizmoAction::SettingsChanged;
            }

            ui.separator();

            // Gizmo mode
            ui.label("Mode:");
            ui.horizontal(|ui| {
                if ui.selectable_label(settings.mode == 0, "Translate").clicked() {
                    settings.mode = 0;
                    action = GizmoAction::SettingsChanged;
                }
                if ui.selectable_label(settings.mode == 1, "Rotate").clicked() {
                    settings.mode = 1;
                    action = GizmoAction::SettingsChanged;
                }
                if ui.selectable_label(settings.mode == 2, "Scale").clicked() {
                    settings.mode = 2;
                    action = GizmoAction::SettingsChanged;
                }
            });

            // Gizmo space
            ui.label("Space:");
            ui.horizontal(|ui| {
                if ui.selectable_label(settings.space == 0, "World").clicked() {
                    settings.space = 0;
                    action = GizmoAction::SettingsChanged;
                }
                if ui.selectable_label(settings.space == 1, "Local").clicked() {
                    settings.space = 1;
                    action = GizmoAction::SettingsChanged;
                }
            });

            ui.separator();

            // Snap settings
            ui.label("Snap:");
            ui.horizontal(|ui| {
                ui.label("Translate:");
                if ui
                    .add(DragValue::new(&mut settings.snap_translate).speed(0.1).range(0.0..=10.0))
                    .changed()
                {
                    action = GizmoAction::SettingsChanged;
                }
            });
            ui.horizontal(|ui| {
                ui.label("Rotate:");
                if ui
                    .add(DragValue::new(&mut settings.snap_rotate).speed(1.0).range(0.0..=90.0).suffix("째"))
                    .changed()
                {
                    action = GizmoAction::SettingsChanged;
                }
            });
            ui.horizontal(|ui| {
                ui.label("Scale:");
                if ui
                    .add(DragValue::new(&mut settings.snap_scale).speed(0.1).range(0.0..=1.0))
                    .changed()
                {
                    action = GizmoAction::SettingsChanged;
                }
            });

            // Transform editing (only if selected)
            if selection.has_selection {
                ui.separator();
                ui.label("Transform:");

                // Translation
                ui.horizontal(|ui| {
                    ui.label("Pos:");
                    let mut changed = false;
                    changed |= ui.add(DragValue::new(&mut selection.translation[0]).speed(0.1).prefix("X:")).changed();
                    changed |= ui.add(DragValue::new(&mut selection.translation[1]).speed(0.1).prefix("Y:")).changed();
                    changed |= ui.add(DragValue::new(&mut selection.translation[2]).speed(0.1).prefix("Z:")).changed();
                    if changed && action == GizmoAction::None {
                        action = GizmoAction::TransformChanged;
                    }
                });

                // Rotation (Euler angles)
                ui.horizontal(|ui| {
                    ui.label("Rot:");
                    let mut changed = false;
                    changed |= ui.add(DragValue::new(&mut selection.rotation_degrees[0]).speed(1.0).prefix("X:").suffix("째")).changed();
                    changed |= ui.add(DragValue::new(&mut selection.rotation_degrees[1]).speed(1.0).prefix("Y:").suffix("째")).changed();
                    changed |= ui.add(DragValue::new(&mut selection.rotation_degrees[2]).speed(1.0).prefix("Z:").suffix("째")).changed();
                    if changed && action == GizmoAction::None {
                        action = GizmoAction::TransformChanged;
                    }
                });

                // Scale
                ui.horizontal(|ui| {
                    ui.label("Scale:");
                    let mut changed = false;
                    changed |= ui.add(DragValue::new(&mut selection.scale[0]).speed(0.01).prefix("X:").range(0.01..=100.0)).changed();
                    changed |= ui.add(DragValue::new(&mut selection.scale[1]).speed(0.01).prefix("Y:").range(0.01..=100.0)).changed();
                    changed |= ui.add(DragValue::new(&mut selection.scale[2]).speed(0.01).prefix("Z:").range(0.01..=100.0)).changed();
                    if changed && action == GizmoAction::None {
                        action = GizmoAction::TransformChanged;
                    }
                });

                ui.separator();
                if ui.button("Reset Transform").clicked() {
                    action = GizmoAction::ResetTransform;
                }
            }
        });

    action
}
```

**Step 2: Run compilation check**

Run: `cargo check -p polyscope-ui`
Expected: No errors

**Step 3: Commit**

```bash
git add crates/polyscope-ui/src/panels.rs
git commit -m "feat(ui): add gizmo section builder"
```

---

## Task 4: Export New Types from UI Crate

**Files:**
- Modify: `crates/polyscope-ui/src/lib.rs`

**Step 1: Update exports**

Update `crates/polyscope-ui/src/lib.rs` to export the new types:

```rust
pub use panels::{
    AppearanceSettings, CameraSettings, GizmoAction, GizmoSettings, GroupSettings, GroupsAction,
    SceneExtents, SelectionInfo, SlicePlaneSettings, SlicePlanesAction,
};
```

**Step 2: Run compilation check**

Run: `cargo check -p polyscope-ui`
Expected: No errors

**Step 3: Commit**

```bash
git add crates/polyscope-ui/src/lib.rs
git commit -m "feat(ui): export gizmo UI types"
```

---

## Task 5: Add Gizmo Sync Functions to Main Crate

**Files:**
- Modify: `crates/polyscope/src/lib.rs` (add after group sync functions)

**Step 1: Update re-exports**

Find the UI re-exports line and update to include new types:

```rust
pub use polyscope_ui::{
    AppearanceSettings, CameraSettings, GizmoAction, GizmoSettings, GroupSettings, GroupsAction,
    SceneExtents, SelectionInfo, SlicePlaneSettings, SlicePlanesAction,
};
```

**Step 2: Add sync functions**

Add after the group sync functions:

```rust
// ============================================================================
// Gizmo UI Sync Functions
// ============================================================================

/// Gets gizmo settings for UI.
pub fn get_gizmo_settings() -> polyscope_ui::GizmoSettings {
    with_context(|ctx| {
        let gizmo = ctx.gizmo();
        polyscope_ui::GizmoSettings {
            mode: match gizmo.mode {
                GizmoMode::Translate => 0,
                GizmoMode::Rotate => 1,
                GizmoMode::Scale => 2,
            },
            space: match gizmo.space {
                GizmoSpace::World => 0,
                GizmoSpace::Local => 1,
            },
            visible: gizmo.visible,
            snap_translate: gizmo.snap_translate,
            snap_rotate: gizmo.snap_rotate,
            snap_scale: gizmo.snap_scale,
        }
    })
}

/// Applies gizmo settings from UI.
pub fn apply_gizmo_settings(settings: &polyscope_ui::GizmoSettings) {
    with_context_mut(|ctx| {
        let gizmo = ctx.gizmo_mut();
        gizmo.mode = match settings.mode {
            0 => GizmoMode::Translate,
            1 => GizmoMode::Rotate,
            _ => GizmoMode::Scale,
        };
        gizmo.space = match settings.space {
            0 => GizmoSpace::World,
            _ => GizmoSpace::Local,
        };
        gizmo.visible = settings.visible;
        gizmo.snap_translate = settings.snap_translate;
        gizmo.snap_rotate = settings.snap_rotate;
        gizmo.snap_scale = settings.snap_scale;
    });
}

/// Gets selection info for UI.
pub fn get_selection_info() -> polyscope_ui::SelectionInfo {
    with_context(|ctx| {
        if let Some((type_name, name)) = ctx.selected_structure() {
            // Get transform from selected structure
            let transform = ctx
                .registry
                .get(type_name, name)
                .map(|s| s.transform())
                .unwrap_or(Mat4::IDENTITY);

            let t = Transform::from_matrix(transform);
            let euler = t.euler_angles_degrees();

            polyscope_ui::SelectionInfo {
                has_selection: true,
                type_name: type_name.to_string(),
                name: name.to_string(),
                translation: t.translation.to_array(),
                rotation_degrees: euler.to_array(),
                scale: t.scale.to_array(),
            }
        } else {
            polyscope_ui::SelectionInfo::default()
        }
    })
}

/// Applies transform from selection info to the selected structure.
pub fn apply_selection_transform(selection: &polyscope_ui::SelectionInfo) {
    if !selection.has_selection {
        return;
    }

    let translation = Vec3::from_array(selection.translation);
    let rotation = glam::Quat::from_euler(
        glam::EulerRot::XYZ,
        selection.rotation_degrees[0].to_radians(),
        selection.rotation_degrees[1].to_radians(),
        selection.rotation_degrees[2].to_radians(),
    );
    let scale = Vec3::from_array(selection.scale);

    let transform = Mat4::from_scale_rotation_translation(scale, rotation, translation);

    with_context_mut(|ctx| {
        if let Some((type_name, name)) = ctx.selected_structure.clone() {
            if let Some(structure) = ctx.registry.get_mut(&type_name, &name) {
                structure.set_transform(transform);
            }
        }
    });
}

/// Handles a gizmo UI action.
pub fn handle_gizmo_action(
    action: polyscope_ui::GizmoAction,
    settings: &polyscope_ui::GizmoSettings,
    selection: &polyscope_ui::SelectionInfo,
) {
    match action {
        polyscope_ui::GizmoAction::None => {}
        polyscope_ui::GizmoAction::SettingsChanged => {
            apply_gizmo_settings(settings);
        }
        polyscope_ui::GizmoAction::TransformChanged => {
            apply_selection_transform(selection);
        }
        polyscope_ui::GizmoAction::Deselect => {
            deselect_structure();
        }
        polyscope_ui::GizmoAction::ResetTransform => {
            reset_selected_transform();
        }
    }
}
```

**Step 3: Run compilation check**

Run: `cargo check -p polyscope`
Expected: No errors

**Step 4: Commit**

```bash
git add crates/polyscope/src/lib.rs
git commit -m "feat: add gizmo UI sync functions"
```

---

## Task 6: Add Tests for Gizmo UI Sync

**Files:**
- Modify: `crates/polyscope/src/lib.rs` (add tests at end of test module)

**Step 1: Add tests**

Add to the tests module at the end of `crates/polyscope/src/lib.rs`:

```rust
    #[test]
    fn test_get_gizmo_settings() {
        setup();

        // Set known values
        set_gizmo_mode(GizmoMode::Rotate);
        set_gizmo_space(GizmoSpace::Local);
        set_gizmo_visible(false);
        set_gizmo_snap_translate(0.5);
        set_gizmo_snap_rotate(15.0);
        set_gizmo_snap_scale(0.1);

        let settings = get_gizmo_settings();
        assert_eq!(settings.mode, 1); // Rotate
        assert_eq!(settings.space, 1); // Local
        assert!(!settings.visible);
        assert!((settings.snap_translate - 0.5).abs() < 0.001);
        assert!((settings.snap_rotate - 15.0).abs() < 0.001);
        assert!((settings.snap_scale - 0.1).abs() < 0.001);
    }

    #[test]
    fn test_apply_gizmo_settings() {
        setup();

        let settings = polyscope_ui::GizmoSettings {
            mode: 2,  // Scale
            space: 0, // World
            visible: true,
            snap_translate: 1.0,
            snap_rotate: 45.0,
            snap_scale: 0.25,
        };

        apply_gizmo_settings(&settings);

        assert_eq!(get_gizmo_mode(), GizmoMode::Scale);
        assert_eq!(get_gizmo_space(), GizmoSpace::World);
        assert!(is_gizmo_visible());
    }

    #[test]
    fn test_get_selection_info_no_selection() {
        setup();
        deselect_structure();

        let info = get_selection_info();
        assert!(!info.has_selection);
    }

    #[test]
    fn test_get_selection_info_with_selection() {
        setup();
        let name = unique_name("gizmo_select_pc");

        register_point_cloud(&name, vec![Vec3::ZERO]);
        select_structure("PointCloud", &name);

        let info = get_selection_info();
        assert!(info.has_selection);
        assert_eq!(info.type_name, "PointCloud");
        assert_eq!(info.name, name);

        deselect_structure();
    }

    #[test]
    fn test_apply_selection_transform() {
        setup();
        let name = unique_name("gizmo_transform_pc");

        register_point_cloud(&name, vec![Vec3::ZERO]);
        select_structure("PointCloud", &name);

        let selection = polyscope_ui::SelectionInfo {
            has_selection: true,
            type_name: "PointCloud".to_string(),
            name: name.clone(),
            translation: [1.0, 2.0, 3.0],
            rotation_degrees: [0.0, 0.0, 0.0],
            scale: [1.0, 1.0, 1.0],
        };

        apply_selection_transform(&selection);

        let transform = get_point_cloud_transform(&name).unwrap();
        let translation = transform.w_axis.truncate();
        assert!((translation - Vec3::new(1.0, 2.0, 3.0)).length() < 0.001);

        deselect_structure();
    }
```

**Step 2: Run tests**

Run: `cargo test -p polyscope -- gizmo`
Expected: All tests pass

**Step 3: Commit**

```bash
git add crates/polyscope/src/lib.rs
git commit -m "test: add gizmo UI sync tests"
```

---

## Task 7: Wire Gizmo Panel into App

**Files:**
- Modify: `crates/polyscope/src/app.rs`

**Step 1: Add gizmo UI state to App struct**

Find the App struct (around line 25) and add after `new_group_name`:

```rust
    // Gizmo UI state
    gizmo_settings: polyscope_ui::GizmoSettings,
    selection_info: polyscope_ui::SelectionInfo,
```

**Step 2: Initialize gizmo state in App::new()**

In `App::new()`, add after `new_group_name: String::new(),`:

```rust
            gizmo_settings: crate::get_gizmo_settings(),
            selection_info: polyscope_ui::SelectionInfo::default(),
```

**Step 3: Add gizmo section to UI building**

In the `render()` function, find where groups section is built and add after it (before `build_ground_plane_section`):

```rust
            // Sync selection info from context
            self.selection_info = crate::get_selection_info();

            // Gizmo section
            let gizmo_action = polyscope_ui::panels::build_gizmo_section(
                ui,
                &mut self.gizmo_settings,
                &mut self.selection_info,
            );
            if gizmo_action != polyscope_ui::GizmoAction::None {
                crate::handle_gizmo_action(
                    gizmo_action,
                    &self.gizmo_settings,
                    &self.selection_info,
                );
            }
```

**Step 4: Run compilation check**

Run: `cargo check -p polyscope`
Expected: No errors

**Step 5: Commit**

```bash
git add crates/polyscope/src/app.rs
git commit -m "feat: wire gizmo panel into app UI"
```

---

## Task 8: Run Full Test Suite and Verify

**Step 1: Run all tests**

Run: `cargo test --workspace`
Expected: All tests pass

**Step 2: Run clippy**

Run: `cargo clippy --workspace`
Expected: No warnings (or acceptable warnings only)

**Step 3: Format code**

Run: `cargo fmt --all`
Expected: Code formatted

**Step 4: Final commit if needed**

```bash
git add -A
git commit -m "chore: format code"
```

---

## Summary

This plan adds a Gizmo/Transform UI panel with:

1. **GizmoSettings struct** - UI representation of gizmo config (mode, space, visible, snap values)
2. **SelectionInfo struct** - Current selection with transform (translation, rotation, scale)
3. **GizmoAction enum** - Actions (SettingsChanged, TransformChanged, Deselect, ResetTransform)
4. **build_gizmo_section** - Main panel with selection info, gizmo controls, transform editing
5. **Sync functions** - get_gizmo_settings(), apply_gizmo_settings(), get_selection_info(), apply_selection_transform()
6. **App integration** - Wired into main UI panel

UI Features:
- Display current selection (type and name)
- Deselect button
- Gizmo visibility toggle
- Gizmo mode selector (Translate, Rotate, Scale)
- Gizmo space selector (World, Local)
- Snap settings (translate distance, rotate degrees, scale factor)
- Transform editing (position XYZ, rotation XYZ degrees, scale XYZ)
- Reset transform button
