# Groups UI Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add UI panel for managing groups, allowing users to create, remove, enable/disable groups and see their structure membership through the GUI.

**Architecture:** Create UI data structures and panel builders in polyscope-ui that interact with the existing Group backend in polyscope-core. The UI displays groups in a tree structure with enable/disable toggles and shows contained structures per group.

**Tech Stack:** Rust, egui, glam

---

## Task 1: Add GroupSettings Struct to UI Crate

**Files:**
- Modify: `crates/polyscope-ui/src/panels.rs` (add after SlicePlaneSettings)

**Step 1: Add GroupSettings struct**

Add after the `SlicePlaneSettings` and related code in `crates/polyscope-ui/src/panels.rs`:

```rust
/// Settings for a single group in the UI.
#[derive(Debug, Clone)]
pub struct GroupSettings {
    /// Name of the group.
    pub name: String,
    /// Whether the group is enabled (visible).
    pub enabled: bool,
    /// Whether to show child details in UI.
    pub show_child_details: bool,
    /// Parent group name (if any).
    pub parent_group: Option<String>,
    /// Child structure identifiers (type_name, name).
    pub child_structures: Vec<(String, String)>,
    /// Child group names.
    pub child_groups: Vec<String>,
}

impl Default for GroupSettings {
    fn default() -> Self {
        Self {
            name: String::new(),
            enabled: true,
            show_child_details: true,
            parent_group: None,
            child_structures: Vec::new(),
            child_groups: Vec::new(),
        }
    }
}

impl GroupSettings {
    /// Creates settings with a name.
    pub fn with_name(name: impl Into<String>) -> Self {
        Self {
            name: name.into(),
            ..Default::default()
        }
    }
}
```

**Step 2: Run compilation check**

Run: `cargo check -p polyscope-ui`
Expected: No errors

**Step 3: Commit**

```bash
git add crates/polyscope-ui/src/panels.rs
git commit -m "feat(ui): add GroupSettings struct"
```

---

## Task 2: Add GroupsAction Enum

**Files:**
- Modify: `crates/polyscope-ui/src/panels.rs`

**Step 1: Add GroupsAction enum**

Add after `GroupSettings`:

```rust
/// Actions that can be triggered from the groups UI.
#[derive(Debug, Clone, PartialEq, Eq)]
pub enum GroupsAction {
    /// No action.
    None,
    /// Create a new group with the given name.
    Create(String),
    /// Remove group at the given index.
    Remove(usize),
    /// Toggle enabled state for group at index.
    ToggleEnabled(usize),
    /// Toggle show_child_details for group at index.
    ToggleDetails(usize),
}
```

**Step 2: Run compilation check**

Run: `cargo check -p polyscope-ui`
Expected: No errors

**Step 3: Commit**

```bash
git add crates/polyscope-ui/src/panels.rs
git commit -m "feat(ui): add GroupsAction enum"
```

---

## Task 3: Add Single Group Item UI Builder

**Files:**
- Modify: `crates/polyscope-ui/src/panels.rs`

**Step 1: Add build_group_item function**

Add after `GroupsAction`:

```rust
/// Builds UI for a single group item.
/// Returns true if enabled was toggled.
fn build_group_item(ui: &mut Ui, settings: &mut GroupSettings) -> bool {
    let mut toggled = false;

    // Enabled checkbox
    ui.horizontal(|ui| {
        if ui.checkbox(&mut settings.enabled, "Enabled").changed() {
            toggled = true;
        }
    });

    // Show child details checkbox
    ui.horizontal(|ui| {
        ui.checkbox(&mut settings.show_child_details, "Show details");
    });

    // Show parent if any
    if let Some(ref parent) = settings.parent_group {
        ui.horizontal(|ui| {
            ui.label("Parent:");
            ui.label(parent);
        });
    }

    // Show child structures
    if !settings.child_structures.is_empty() {
        ui.separator();
        ui.label("Structures:");
        ui.indent("structures", |ui| {
            for (type_name, name) in &settings.child_structures {
                ui.horizontal(|ui| {
                    ui.label(format!("[{}]", type_name));
                    ui.label(name);
                });
            }
        });
    }

    // Show child groups
    if !settings.child_groups.is_empty() {
        ui.separator();
        ui.label("Child groups:");
        ui.indent("child_groups", |ui| {
            for child_name in &settings.child_groups {
                ui.label(format!("  {}", child_name));
            }
        });
    }

    // Show empty state
    if settings.child_structures.is_empty() && settings.child_groups.is_empty() {
        ui.label("(empty)");
    }

    toggled
}
```

**Step 2: Run compilation check**

Run: `cargo check -p polyscope-ui`
Expected: No errors

**Step 3: Commit**

```bash
git add crates/polyscope-ui/src/panels.rs
git commit -m "feat(ui): add single group item UI builder"
```

---

## Task 4: Add Groups Section Builder

**Files:**
- Modify: `crates/polyscope-ui/src/panels.rs`

**Step 1: Add build_groups_section function**

Add after `build_group_item`:

```rust
/// Builds the groups section.
/// Returns an action if one was triggered.
pub fn build_groups_section(
    ui: &mut Ui,
    groups: &mut Vec<GroupSettings>,
    new_group_name: &mut String,
) -> GroupsAction {
    let mut action = GroupsAction::None;

    CollapsingHeader::new("Groups")
        .default_open(false)
        .show(ui, |ui| {
            // Add new group controls
            ui.horizontal(|ui| {
                ui.label("New group:");
                ui.text_edit_singleline(new_group_name);
                if ui.button("Create").clicked() && !new_group_name.is_empty() {
                    action = GroupsAction::Create(new_group_name.clone());
                }
            });

            if groups.is_empty() {
                ui.label("No groups");
                return;
            }

            ui.separator();

            // Show only root groups (those without parents)
            let root_groups: Vec<usize> = groups
                .iter()
                .enumerate()
                .filter(|(_, g)| g.parent_group.is_none())
                .map(|(i, _)| i)
                .collect();

            let mut remove_idx = None;

            for idx in root_groups {
                let group = &mut groups[idx];
                let header_text = format!(
                    "{} {} ({})",
                    if group.enabled { "●" } else { "○" },
                    group.name,
                    group.child_structures.len()
                );

                CollapsingHeader::new(header_text)
                    .id_salt(format!("group_{}", idx))
                    .default_open(false)
                    .show(ui, |ui| {
                        if build_group_item(ui, group) && action == GroupsAction::None {
                            action = GroupsAction::ToggleEnabled(idx);
                        }

                        ui.separator();
                        if ui.button("Remove").clicked() {
                            remove_idx = Some(idx);
                        }
                    });
            }

            if let Some(idx) = remove_idx {
                action = GroupsAction::Remove(idx);
            }
        });

    action
}
```

**Step 2: Run compilation check**

Run: `cargo check -p polyscope-ui`
Expected: No errors

**Step 3: Commit**

```bash
git add crates/polyscope-ui/src/panels.rs
git commit -m "feat(ui): add groups section builder"
```

---

## Task 5: Export New Types from UI Crate

**Files:**
- Modify: `crates/polyscope-ui/src/lib.rs`

**Step 1: Update exports**

Update `crates/polyscope-ui/src/lib.rs` to export the new types:

```rust
pub use panels::{
    AppearanceSettings, CameraSettings, GroupSettings, GroupsAction, SceneExtents,
    SlicePlaneSettings, SlicePlanesAction,
};
```

**Step 2: Run compilation check**

Run: `cargo check -p polyscope-ui`
Expected: No errors

**Step 3: Commit**

```bash
git add crates/polyscope-ui/src/lib.rs
git commit -m "feat(ui): export group UI types"
```

---

## Task 6: Add Group Sync Functions to Main Crate

**Files:**
- Modify: `crates/polyscope/src/lib.rs` (add after slice plane sync functions)

**Step 1: Update re-exports**

Find the UI re-exports line and update to include new types:

```rust
pub use polyscope_ui::{
    AppearanceSettings, CameraSettings, GroupSettings, GroupsAction, SceneExtents,
    SlicePlaneSettings, SlicePlanesAction,
};
```

**Step 2: Add sync functions**

Add after the slice plane sync functions:

```rust
// ============================================================================
// Group UI Sync Functions
// ============================================================================

/// Gets all groups as UI settings.
pub fn get_group_settings() -> Vec<polyscope_ui::GroupSettings> {
    with_context(|ctx| {
        ctx.groups
            .values()
            .map(|group| polyscope_ui::GroupSettings {
                name: group.name().to_string(),
                enabled: group.is_enabled(),
                show_child_details: group.show_child_details(),
                parent_group: group.parent_group().map(|s| s.to_string()),
                child_structures: group
                    .child_structures()
                    .map(|(t, n)| (t.to_string(), n.to_string()))
                    .collect(),
                child_groups: group.child_groups().map(|s| s.to_string()).collect(),
            })
            .collect()
    })
}

/// Applies UI settings to a group.
pub fn apply_group_settings(settings: &polyscope_ui::GroupSettings) {
    with_context_mut(|ctx| {
        if let Some(group) = ctx.get_group_mut(&settings.name) {
            group.set_enabled(settings.enabled);
            group.set_show_child_details(settings.show_child_details);
        }
    });
}

/// Handles a group UI action.
pub fn handle_group_action(
    action: polyscope_ui::GroupsAction,
    current_settings: &mut Vec<polyscope_ui::GroupSettings>,
) {
    match action {
        polyscope_ui::GroupsAction::None => {}
        polyscope_ui::GroupsAction::Create(name) => {
            create_group(&name);
            current_settings.push(polyscope_ui::GroupSettings::with_name(&name));
        }
        polyscope_ui::GroupsAction::Remove(idx) => {
            if idx < current_settings.len() {
                let name = &current_settings[idx].name;
                remove_group(name);
                current_settings.remove(idx);
            }
        }
        polyscope_ui::GroupsAction::ToggleEnabled(idx) => {
            if idx < current_settings.len() {
                apply_group_settings(&current_settings[idx]);
            }
        }
        polyscope_ui::GroupsAction::ToggleDetails(idx) => {
            if idx < current_settings.len() {
                apply_group_settings(&current_settings[idx]);
            }
        }
    }
}
```

**Step 3: Run compilation check**

Run: `cargo check -p polyscope`
Expected: No errors

**Step 4: Commit**

```bash
git add crates/polyscope/src/lib.rs
git commit -m "feat: add group UI sync functions"
```

---

## Task 7: Add Tests for Group UI Sync

**Files:**
- Modify: `crates/polyscope/src/lib.rs` (add tests at end of test module)

**Step 1: Add tests**

Add to the tests module at the end of `crates/polyscope/src/lib.rs`:

```rust
    #[test]
    fn test_get_group_settings() {
        setup();
        let name = unique_name("ui_group");
        let pc_name = unique_name("pc_in_ui_group");

        // Create group and add a structure
        let handle = create_group(&name);
        register_point_cloud(&pc_name, vec![Vec3::ZERO]);
        handle.add_point_cloud(&pc_name);

        // Get settings
        let settings = get_group_settings();
        let found = settings.iter().find(|s| s.name == name);
        assert!(found.is_some());

        let s = found.unwrap();
        assert!(s.enabled);
        assert!(s.show_child_details);
        assert_eq!(s.child_structures.len(), 1);
        assert_eq!(s.child_structures[0], ("PointCloud".to_string(), pc_name));
    }

    #[test]
    fn test_apply_group_settings() {
        setup();
        let name = unique_name("apply_group");

        // Create group
        create_group(&name);

        // Create modified settings
        let settings = polyscope_ui::GroupSettings {
            name: name.clone(),
            enabled: false,
            show_child_details: false,
            parent_group: None,
            child_structures: Vec::new(),
            child_groups: Vec::new(),
        };

        // Apply settings
        apply_group_settings(&settings);

        // Verify
        let handle = get_group(&name).unwrap();
        assert!(!handle.is_enabled());
    }

    #[test]
    fn test_handle_group_action_create() {
        setup();
        let name = unique_name("action_create_group");
        let mut settings = Vec::new();

        handle_group_action(
            polyscope_ui::GroupsAction::Create(name.clone()),
            &mut settings,
        );

        assert_eq!(settings.len(), 1);
        assert_eq!(settings[0].name, name);
        assert!(get_group(&name).is_some());
    }

    #[test]
    fn test_handle_group_action_remove() {
        setup();
        let name = unique_name("action_remove_group");

        // Create group
        create_group(&name);
        let mut settings = vec![polyscope_ui::GroupSettings::with_name(&name)];

        // Remove via action
        handle_group_action(polyscope_ui::GroupsAction::Remove(0), &mut settings);

        assert!(settings.is_empty());
        assert!(get_group(&name).is_none());
    }
```

**Step 2: Run tests**

Run: `cargo test -p polyscope -- group`
Expected: All tests pass

**Step 3: Commit**

```bash
git add crates/polyscope/src/lib.rs
git commit -m "test: add group UI sync tests"
```

---

## Task 8: Wire Groups Panel into App

**Files:**
- Modify: `crates/polyscope/src/app.rs`

**Step 1: Add group UI state to App struct**

Find the App struct (around line 25) and add after `new_slice_plane_name`:

```rust
    // Group UI state
    group_settings: Vec<polyscope_ui::GroupSettings>,
    new_group_name: String,
```

**Step 2: Initialize group state in App::new()**

In `App::new()` (around line 57), add after `new_slice_plane_name: String::new(),`:

```rust
            group_settings: crate::get_group_settings(),
            new_group_name: String::new(),
```

**Step 3: Add groups section to UI building**

In the `render()` function, find where slice planes section is built (around line 284) and add after it (before `build_ground_plane_section`):

```rust
            // Groups section
            let groups_action = polyscope_ui::panels::build_groups_section(
                ui,
                &mut self.group_settings,
                &mut self.new_group_name,
            );
            if groups_action != polyscope_ui::GroupsAction::None {
                crate::handle_group_action(groups_action.clone(), &mut self.group_settings);
                if matches!(groups_action, polyscope_ui::GroupsAction::Create(_)) {
                    self.new_group_name.clear();
                }
            }
```

**Step 4: Run compilation check**

Run: `cargo check -p polyscope`
Expected: No errors

**Step 5: Commit**

```bash
git add crates/polyscope/src/app.rs
git commit -m "feat: wire groups panel into app UI"
```

---

## Task 9: Run Full Test Suite and Verify

**Step 1: Run all tests**

Run: `cargo test --workspace`
Expected: All tests pass

**Step 2: Run clippy**

Run: `cargo clippy --workspace`
Expected: No warnings

**Step 3: Format code**

Run: `cargo fmt --all`
Expected: Code formatted

**Step 4: Final commit if needed**

```bash
git add -A
git commit -m "chore: format code"
```

---

## Summary

This plan adds a Groups UI panel with:

1. **GroupSettings struct** - UI representation of group state (name, enabled, parent, children)
2. **GroupsAction enum** - Actions (Create, Remove, ToggleEnabled, ToggleDetails)
3. **build_group_item** - UI for single group (enabled toggle, details toggle, member display)
4. **build_groups_section** - Main panel with group list and create/remove controls
5. **Sync functions** - get_group_settings(), apply_group_settings(), handle_group_action()
6. **App integration** - Wired into main UI panel

UI Features:
- Create new groups by name
- Remove existing groups
- Enable/disable groups (affects visibility of contained structures)
- Toggle "show details" per group
- View parent group (if hierarchical)
- View contained structures (type and name)
- View child groups (for hierarchical organization)
- Root groups shown at top level, child groups nested
